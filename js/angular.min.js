var app=angular.module("eleme",["ionic"]);app.factory("$debounce",["$rootScope","$browser","$q","$exceptionHandler",function(b,a,e,f){var h={},d={},g=0;function c(p,m,n){var r=e.defer(),s=r.promise,k=(angular.isDefined(n)&&!n),q,i,o,j=false;angular.forEach(d,function(u,t){if(angular.equals(d[t].fn,p)){j=true;o=t}});if(!j){o=g++;d[o]={fn:p}}else{h[d[o].timeoutId].reject("bounced");a.defer.cancel(d[o].timeoutId)}var l=function(){delete d[o];try{r.resolve(p())}catch(t){r.reject(t);f(t)}if(!k){b.$apply()}};q=a.defer(l,m);d[o].timeoutId=q;i=function(t){delete h[s.$$timeoutId]};s.$$timeoutId=q;h[q]=r;s.then(i,i);return s}c.cancel=function(i){if(i&&i.$$timeoutId in h){h[i.$$timeoutId].reject("canceled");return a.defer.cancel(i.$$timeoutId)}return false};return c}]);app.config(function(b,a){b.state("start",{url:"/kflstart",templateUrl:"tpl/start.html",controller:"startCtrl"}).state("main",{url:"/kflmain",templateUrl:"tpl/main.html",controller:"mainCtrl"}).state("detail",{url:"/kfldetail/:id",templateUrl:"tpl/detail.html",controller:"detailCtrl"}).state("myorder",{url:"/kflmyorder",templateUrl:"tpl/myorder.html",controller:"myorderCtrl"}).state("setting",{url:"/kflsetting",templateUrl:"tpl/settings.html",controller:"settingCtrl"}).state("cart",{url:"/kflcart",templateUrl:"tpl/cart.html",controller:"cartCtrl"}).state("register",{url:"/kflregister",templateUrl:"tpl/register.html",controller:"registerCtrl"}).state("Login",{url:"/kflLogin",templateUrl:"tpl/Login.html",controller:"LoginCtrl"}).state("success",{url:"/kflsuccess/:oid",templateUrl:"tpl/include/success.html",controller:"successCtrl"});a.otherwise("/kflstart")});app.run(function(a){a.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded"}});app.controller("startCtrl",["$scope",function(a){}]);app.controller("mainCtrl",["$scope","$http","$debounce","$ionicLoading","$timeout",function(a,c,b){a.hasMore=true;a.shwo=false;c.get("data/dish_getbypage.php?start="+0).success(function(d){a.list=d;console.log(a.list)});a.parent={search:""};a.$watch("parent.search",function(){b(watchSearch,300)});watchSearch=function(){console.log("搜索打印："+a.parent.search);if(a.parent.search){c({method:"post",url:"data/dish_getbykw.php?search="+a.parent.search}).success(function(d){a.list=d;if(a.list.length<1){a.shwo=true}else{if(a.list.length>0){a.shwo=false}else{if(a.list.code==-1){console.log(a.list.msg)}}}console.log(a.list)})}else{c.get("data/dish_getbypage.php?start="+0).success(function(d){a.list=d})}};a.btn=function(){c.get("data/dish_getbypage.php?start="+a.list.length).success(function(d){if(d.length<5){a.hasMore=false}a.list=a.list.concat(d);a.shwo=false;console.log(a.list)})};a.loadMore=function(){c.get("data/dish_getbypage.php?start="+a.list.length).success(function(d){if(d.length<5){a.hasMore=false}a.list=a.list.concat(d);a.$broadcast("scroll.infiniteScrollComplete");a.shwo=false;console.log(a.list)})}}]);app.controller("detailCtrl",["$scope","$stateParams","$http","$ionicPopup","$state",function(a,c,e,d,b){console.log("获取商品id："+c.id);e.get("data/dish_getbyid.php?id="+c.id).success(function(f){console.log(f[0]);a.list=f[0]});a.add_order=function(){e.get("data/login_do.php").success(function(g){a.userlist=g[0];console.log(a.userlist);if(a.userlist.code==-1){b.go("register")}else{if(a.userlist.code==1){var f="did="+a.list.did+"&uid="+a.userlist.userid+"&count=-1";console.log(f);e.post("data/cart_update.php",f).success(function(h){console.log(h);a.data.totalNumInCart++;d.alert({title:"购物车弹出框",template:"确认添加成功"})})}}})}}]);app.controller("myorderCtrl",["$scope","$http","$state",function(a,c,b){c.get("data/login_do.php").success(function(d){a.userlist=d;console.log(a.userlist);if(a.userlist.code==-1){b.go("Login")}else{c.get("data/order_getbyuserid.php?userid="+a.userlist.userid).success(function(e){console.log(e);a.list=e.data;if(a.list.length<1){a.res="无订单去主页购买"}})}})}]);app.controller("cartCtrl",["$scope","$http","$ionicModal","$httpParamSerializerJQLike","$ionicLoading","$state",function(b,f,a,d,e,c){f.get("data/login_do.php").success(function(g){b.userlist=g;console.log(b.userlist);f.get("data/cart_select.php?uid="+b.userlist.userid).success(function(i){b.list=i.data;updateTotaNum=function(){b.data.totalNumInCart=0;angular.forEach(b.list,function(l,k){b.data.totalNumInCart+=parseInt(l.dishCount)})};console.log(b.list);updateTotaNum();if(b.list.length<1){b.cart_ts="购物车无商品！"}b.sumAll=function(){var k=0;angular.forEach(b.list,function(m,l){k+=(m.price*m.dishCount)});return k};var j=0;angular.forEach(angular.fromJson(b.list),function(l,k){j+=(l.price*l.dishCount)});var h=angular.toJson(b.list);b.order={cartDetail:h,totalprice:j,userid:b.userlist.userid};b.Submit_btn=function(){var k=d(b.order);f.post("data/order_add.php",k).success(function(l){console.log(l);b.modal.hide();b.data.totalNumInCart=0;c.go("myorder")})};b.delete_btn=function(k,l){console.log(k,l);updateTotaNum();f.post("data/cart_update.php?uid="+b.userlist.userid+"&count=-2&did="+b.list[k].did).success(function(m){console.log(m);e.show({template:"成功删除...",duration:500});b.list.splice(k,1);if(b.list.length<1){b.data.totalNumInCart=0}})};b.add_btn=function(k){console.log(k);b.list[k].dishCount++;f.post("data/cart_update.php?uid="+b.userlist.userid+"&count="+b.list[k].dishCount+"&did="+b.list[k].did).success(function(l){console.log(l);updateTotaNum()})};b.minus=function(k){console.log(k);b.list[k].dishCount--;if(b.list[k].dishCount==0){b.list[k].dishCount=1}else{f.post("data/cart_update.php?uid="+b.userlist.userid+"&count="+b.list[k].dishCount+"&did="+b.list[k].did).success(function(l){console.log(l);updateTotaNum()})}};a.fromTemplateUrl("cart_btn.html",{scope:b}).then(function(k){b.modal=k});b.open=function(){if(b.list.length<1){e.show({template:"购物车无商品！",duration:1000})}else{b.modal.show()}};b.close=function(){b.modal.hide()}})})}]);app.controller("settingCtrl",["$scope","$http","$ionicModal","$state",function(b,d,a,c){d.get("data/login_do.php").success(function(e){b.userlist=e;console.log(b.userlist);if(b.userlist.code==-1){c.go("Login")}else{d.get("data/About.php?userid="+b.userlist.userid).success(function(f){console.log(f);b.list=f})}});a.fromTemplateUrl("useropen.html",{scope:b}).then(function(e){b.modal2=e});b.useropen=function(){b.modal2.show()};b.close2=function(){b.modal2.hide()};a.fromTemplateUrl("About.html",{scope:b}).then(function(e){b.modal=e});b.open=function(){b.modal.show()};b.close=function(){b.modal.hide()};b.closeout=function(){d.get("data/login_out.php").success(function(e){c.go("start")}).error(function(){alert("错误")})}}]);app.controller("registerCtrl",["$scope","$http","$httpParamSerializerJQLike","$ionicLoading","$timeout","$state",function(a,f,d,e,c,b){a.data={};a.register_btn=function(){var g=d(a.data);console.log(g);var i=/^[a-z0-9_-]{6,18}$/;var h=/(\+86|0086)?\s*1[34578]\d{9}/;if(!i.test(a.data.pwd)){e.show({template:"密码至少6位数...",duration:1000})}else{if(!h.test(a.data.phone)){e.show({template:"手机号格式不正确...",duration:1000})}else{console.log("手机号通过");f.post("data/register.php",g).success(function(j){console.log(j);e.show({template:"注册成功并登陆...",duration:1000});c(function(){b.go("myorder")},1000)})}}}}]);app.controller("LoginCtrl",["$scope","$state","$ionicLoading","$httpParamSerializerJQLike","$http","$timeout",function(a,c,e,d,f,b){e.show({template:"请登陆...",duration:1000});a.register=function(){c.go("register")};a.data={};a.Login_btn=function(){var g=d(a.data);console.log(g);f.post("data/Login.php",g).success(function(h){console.log(h);if(h==null){e.show({template:"无该账号或密码错误...",duration:1000})}else{e.show({template:"登陆成功即将跳转订单页...",duration:1000});b(function(){c.go("myorder")},1000)}})}}]);app.controller("successCtrl",["$scope","$stateParams",function(a,b){console.log("获取商品id："+b.oid);a.list=b.oid}]);app.controller("parentCtrl",["$scope","$state",function(a,b){a.data={totalNumInCart:0};a.jump=function(c,d){console.log(c,d);b.go(c)}}]);